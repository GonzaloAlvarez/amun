#!/bin/bash

VM_USERNAME="admin"
VM_PASSWORD="admin"
QEMU_SSH_PORT="2221"
TST_DIR="$(dirname "$0")/tst"
PLUGINS=()
PLATFORM=""

# Parse arguments
while [[ $# -gt 0 ]]; do
	case "$1" in
		-p|--plugins)
			shift
			while [[ $# -gt 0 ]] && [[ ! "$1" =~ ^- ]]; do
				PLUGINS+=("$1")
				shift
			done
			;;
		*)
			if [ -z "$PLATFORM" ]; then
				PLATFORM="$1"
			fi
			shift
			;;
	esac
done

function log_output {
	if [ -z "$2" ] || [ "$2" = "true" ]; then
		echo "$(date "+%Y/%m/%d %H:%M:%S") $1"
	fi
}

function cleanup {
	log_output "[HOST] Stopping runner script"
	exit 0
}

function shutdown {
    log_output "[HOST] Shutting down VM"
    tart stop "$INSTANCE_NAME"
    tart delete "$INSTANCE_NAME"
}

function ssh_command() {
	command="$@"

	SSHPASS=$VM_PASSWORD sshpass -e ssh -o StrictHostKeyChecking=no "$VM_USERNAME@$IP_ADDRESS" "$command"
}

function boot_vm {
	BASE_IMAGE=$1
	INSTANCE_NAME=$2

	TART_NO_AUTO_PRUNE="" tart clone "$BASE_IMAGE" "$INSTANCE_NAME"
	trap 'log_output "[HOST] Killing the VM"; tart delete $INSTANCE_NAME; cleanup' SIGINT SIGTERM

	tart run --no-graphics --vnc --dir dev:.. "$INSTANCE_NAME" 2>/dev/null >/dev/null &

	log_output "[HOST] Waiting for VM to boot"
	IP_ADDRESS=$(tart ip "$INSTANCE_NAME" 2>/dev/null)
	until [[ "$IP_ADDRESS" =~ ^([0-9]+\.){3}[0-9]+$ ]]; do
		IP_ADDRESS=$(tart ip "$INSTANCE_NAME" 2>/dev/null)
		sleep 1
	done

    log_output "[HOST] Machine is launching on $IP_ADDRESS"

	ssh-keygen -R "$IP_ADDRESS" >/dev/null 2>/dev/null

	log_output "[HOST] Waiting for SSH to be available on VM"
	until [ "$(SSHPASS=$VM_PASSWORD sshpass -e ssh -q -o ConnectTimeout=1 -o StrictHostKeyChecking=no "$VM_USERNAME@$IP_ADDRESS" pwd)" ]; do
		sleep 1
	done
}

function breakpoint {
    if [ ${DEBUG:-0} -eq 1 ]; then
        SSHPASS=$VM_PASSWORD sshpass -e ssh -q -o ConnectTimeout=1 -o StrictHostKeyChecking=no "$VM_USERNAME@$IP_ADDRESS"
    fi
}

function qemu_ssh_command() {
    local command="$@"
    ssh -p "$QEMU_SSH_PORT" -i "$TST_DIR/test_key" -l archboot \
        -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
        -o LogLevel=ERROR 127.0.0.1 "$command"
}

function qemu_scp() {
    local src="$1"
    local dst="$2"
    scp -P "$QEMU_SSH_PORT" -i "$TST_DIR/test_key" \
        -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
        -o LogLevel=ERROR "$src" "archboot@127.0.0.1:$dst"
}

function qemu_boot_vm() {
    log_output "[HOST] Sourcing QEMU helper functions"
    source "$TST_DIR/common.sh"

    log_output "[HOST] Generating SSH key pair for passwordless auth"
    generate_test_key

    log_output "[HOST] Preparing UEFI firmware"
    uefi_fw
    uefi_vars

    if [ ! -f "$DISK_IMG" ]; then
        log_output "[HOST] No existing disk image found, performing fresh install"
        ssh_keys
        dw_iso
        new_image
        install
        log_output "[HOST] Waiting for VM to shutdown after installation"
        sleep 5
    fi

    log_output "[HOST] Booting Arch VM"
    headless_boot
    log_output "[HOST] Arch VM is ready"
}

function qemu_shutdown() {
    log_output "[HOST] Shutting down QEMU VM"
    pkill -f "qemu-system-aarch64.*archlinuxarm.qcow2" || true
    sleep 2
}

function qemu_cleanup() {
    log_output "[HOST] Cleaning up QEMU artifacts"
    pkill -f "qemu-system-aarch64.*archlinuxarm.qcow2" || true
    rm -f "$TST_DIR/archlinuxarm.qcow2"
    rm -f "$TST_DIR/arch-linux-aarch64.iso"
    rm -f "$TST_DIR/edk2-aarch64-code.fd"
    rm -f "$TST_DIR/edk2-aarch64-vars.fd"
    rm -f "$TST_DIR/ssh_key.pem"
    rm -f "$TST_DIR/test_key"
    rm -f "$TST_DIR/test_key.pub"
}

function qemu_breakpoint {
    if [ ${DEBUG:-0} -eq 1 ]; then
        ssh -p "$QEMU_SSH_PORT" -i "$TST_DIR/test_key" -l archboot \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            127.0.0.1
    fi
}

function test_sequoia {
    boot_vm "ghcr.io/cirruslabs/macos-sequoia-vanilla:latest" amunsonoma

    ssh_command sudo networksetup -setdnsservers "Ethernet" "8.8.8.8"
    ssh_command cp "'/Volumes/My Shared Files/dev/amun/amun'" "~/amun"
    ssh_command chmod +x "~/amun"
    ssh_command "AMUN_REPO='/Volumes/My Shared Files/dev/amun' ./amun"

    for plugin in "${PLUGINS[@]}"; do
        log_output "[HOST] Running plugin: ${plugin}"
        ssh_command "AMUN_REPO='/Volumes/My Shared Files/dev/amun-${plugin}' ./amun ${plugin}"
    done

    breakpoint

    shutdown
}

function test_debian {
    boot_vm "ghcr.io/cirruslabs/debian:bookworm" amunbookworm

    ssh_command sudo mkdir /mnt/shared
    ssh_command sudo mount -t virtiofs com.apple.virtio-fs.automount /mnt/shared
    ssh_command sudo systemctl stop unattended-upgrades
    ssh_command cp "/mnt/shared/dev/amun/amun" "~/amun"
    ssh_command chmod +x "~/amun"
    ssh_command "AMUN_REPO='/mnt/shared/dev/amun' ./amun"

    for plugin in "${PLUGINS[@]}"; do
        log_output "[HOST] Running plugin: ${plugin}"
        ssh_command "AMUN_REPO='/mnt/shared/dev/amun-${plugin}' ./amun ${plugin}"
    done

    breakpoint

    shutdown
}

function test_arch {
    trap 'log_output "[HOST] Interrupted, cleaning up"; qemu_cleanup; cleanup' SIGINT SIGTERM

    qemu_boot_vm

    log_output "[HOST] Creating tarball of amun repository"
    local SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    tar --no-xattrs -czf /tmp/amun.tar.gz -C "$(dirname "$SCRIPT_DIR")" "$(basename "$SCRIPT_DIR")"

    log_output "[HOST] Transferring repository to Arch VM"
    qemu_ssh_command "mkdir -p /home/archboot/.amun"
    qemu_scp /tmp/amun.tar.gz /home/archboot/.amun/amun.tar.gz

    log_output "[HOST] Extracting repository and running amun"
    qemu_ssh_command "cd /home/archboot/.amun && tar --warning=no-unknown-keyword -xzf amun.tar.gz && rm -f amun.tar.gz"
    qemu_ssh_command "cp /home/archboot/.amun/amun/amun ~/amun && chmod +x ~/amun"
    qemu_ssh_command "AMUN_REPO='/home/archboot/.amun/amun' ./amun"

    for plugin in "${PLUGINS[@]}"; do
        log_output "[HOST] Running plugin: ${plugin}"
        tar --no-xattrs -czf "/tmp/amun-${plugin}.tar.gz" -C "$(dirname "$SCRIPT_DIR")" "amun-${plugin}"
        qemu_scp "/tmp/amun-${plugin}.tar.gz" "/home/archboot/.amun/amun-${plugin}.tar.gz"
        qemu_ssh_command "cd /home/archboot/.amun && tar --warning=no-unknown-keyword -xzf amun-${plugin}.tar.gz && rm -f amun-${plugin}.tar.gz"
        qemu_ssh_command "AMUN_REPO='/home/archboot/.amun/amun-${plugin}' ./amun ${plugin}"
    done

    qemu_breakpoint

    log_output "[HOST] Test completed, cleaning up"
    qemu_cleanup
    rm -f /tmp/amun.tar.gz
    rm -f /tmp/amun-*.tar.gz
}

case "$PLATFORM" in
    mac|sequoia)
        test_sequoia
        ;;
    debian)
        test_debian
        ;;
    arch|linux/arch)
        test_arch
        ;;
    linux)
        test_debian
        test_arch
        ;;
    "")
        test_sequoia
        test_debian
        test_arch
        ;;
    *)
        echo "Usage: $0 [platform] [-p|--plugins <plugin> ...]"
        echo ""
        echo "  mac, sequoia     - Test on macOS Sequoia"
        echo "  debian           - Test on Debian Bookworm"
        echo "  arch, linux/arch - Test on Arch Linux"
        echo "  linux            - Test on Debian + Arch"
        echo "  (no args)        - Test on all platforms"
        echo ""
        echo "  -p, --plugins    - Run amun plugins after base provisioning"
        exit 1
        ;;
esac
